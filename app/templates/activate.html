<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卡密激活</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-xl mx-auto px-4 py-8">
        <div class="bg-white shadow rounded-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">卡密激活</h1>
            <p class="text-sm text-gray-600 mb-6">根据最新激活接口文档，请输入需要激活的卡密，系统会直接请求新的激活接口完成操作。</p>

            <label for="cardKey" class="block text-sm font-medium text-gray-700 mb-2">卡密</label>
            <input id="cardKey" type="text" placeholder="请输入卡密" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />

            <button id="activateBtn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition disabled:opacity-60 disabled:cursor-not-allowed" onclick="redeem()">激活卡密</button>

            <div id="result" class="hidden mt-4 p-4 rounded border"></div>
        </div>
    </div>

    <script>
        async function redeem() {
            const keyInput = document.getElementById('cardKey');
            const resultBox = document.getElementById('result');
            const btn = document.getElementById('activateBtn');
            const key = keyInput.value.trim();

            if (!key) {
                showResult('请输入卡密', false);
                return;
            }

            btn.disabled = true;
            showResult('正在激活，请稍候…', true, true);

            try {
                const response = await fetch('/api/public/redeem-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ key })
                });

                const data = await response.json();
                if (response.ok) {
                    const msg = data.msg || '激活成功';
                    showResult(`${msg}${data.result ? `\n卡号：${data.result.card_number || ''}` : ''}`, true);
                } else {
                    const detail = data.detail || data.msg || '激活失败';
                    showResult(detail, false);
                }
            } catch (error) {
                showResult('网络异常，请稍后重试', false);
            } finally {
                btn.disabled = false;
            }
        }

        function showResult(message, success, isLoading = false) {
            const resultBox = document.getElementById('result');
            resultBox.classList.remove('hidden');
            resultBox.classList.toggle('bg-green-50', !!success && !isLoading);
            resultBox.classList.toggle('border-green-200', !!success && !isLoading);
            resultBox.classList.toggle('text-green-700', !!success && !isLoading);
            resultBox.classList.toggle('bg-blue-50', !!isLoading);
            resultBox.classList.toggle('border-blue-200', !!isLoading);
            resultBox.classList.toggle('text-blue-700', !!isLoading);
            resultBox.classList.toggle('bg-red-50', success === false && !isLoading);
            resultBox.classList.toggle('border-red-200', success === false && !isLoading);
            resultBox.classList.toggle('text-red-700', success === false && !isLoading);
            resultBox.textContent = message;
        }
    </script>
</body>
</html>
